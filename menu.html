<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <h1>Bienvenido</h1>
        <p>Has iniciado sesión correctamente.</p>
        <button id="logout" class="btn btn-danger">Logout</button>
        
        <div class="mt-5">
            <h2>Registrar Transacción</h2>
            <form id="transactionForm">
                <div class="form-group">
                    <label for="type">Tipo</label>
                    <select id="type" class="form-control" required>
                        <option value="income">Ingreso</option>
                        <option value="expense">Gasto</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="amount">Monto</label>
                    <input type="number" class="form-control" id="amount" required>
                </div>
                <div class="form-group">
                    <label for="description">Descripción</label>
                    <input type="text" class="form-control" id="description" required>
                </div>
                <button type="submit" class="btn btn-primary">Registrar</button>
            </form>
        </div>
        
        <div class="mt-5">
            <h2>Mis Transacciones</h2>
            <table class="table">
                <thead>
                    <tr>
                        <th>Tipo</th>
                        <th>Monto</th>
                        <th>Descripción</th>
                        <th>Fecha</th>
                    </tr>
                </thead>
                <tbody id="transactionsTable">
                    <!-- Aquí se insertarán las transacciones del usuario -->
                </tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-auth.js";
        import { auth, db } from './firebase-config.js';
        import { collection, addDoc, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-firestore.js";

        console.log('Script loaded');
        let currentUser;

        // Verificar el estado de autenticación
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                console.log('No user is signed in');
                window.location.href = 'index.html';
            } else {
                console.log('User signed in: ', user.uid);
                currentUser = user;
                loadTransactions();
            }
        });

        // Cerrar sesión
        document.getElementById('logout').addEventListener('click', () => {
            signOut(auth).then(() => {
                window.location.href = 'index.html';
            });
        });

        // Registrar transacción
        document.getElementById('transactionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('Submit transaction form');
            const type = document.getElementById('type').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const description = document.getElementById('description').value;

            try {
                await addDoc(collection(db, 'transactions'), {
                    uid: currentUser.uid,
                    type,
                    amount,
                    description,
                    date: new Date()
                });
                document.getElementById('transactionForm').reset();
                loadTransactions();
            } catch (error) {
                console.error('Error registrando la transacción: ', error);
            }
        });

        async function loadTransactions() {
    console.log('Loading transactions');
    const transactionsTable = document.getElementById('transactionsTable');
    transactionsTable.innerHTML = '';

    const q = query(collection(db, 'transactions'), where('uid', '==', currentUser.uid), orderBy('date', 'desc'));
    const querySnapshot = await getDocs(q);

    querySnapshot.forEach((doc) => {
        const data = doc.data();
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${data.type === 'income' ? 'Ingreso' : 'Gasto'}</td>
            <td>${data.amount}</td>
            <td>${data.description}</td>
            <td>${data.date.toDate().toLocaleString()}</td>
        `;
        transactionsTable.appendChild(row);
    });
}

    </script>
</body>
</html>
